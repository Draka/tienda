extends ../../layout_account

block content
  .container
    include ../../fragments/breadcrumb

    .row
      .col-xs-12
        h1 Ver pedido

    .row
      .col-xs-12
        if order.status == 'cancelled' || order.status == 'cancelledAdmin'
          .steps
            each status in ['created','paid','picking','cancelled','cancelledAdmin']
              if _.find(order.statuses, {status})
                .step(class=statusToDate(order.statuses, status)?(order.status==status?' error-300':''):'')
                  .step-icon !{statusIcon(status)}
                  .step-content.hide-sm.hide-md.hide-lg
                    .step-title #{statusText(status)}
                    .step-description #{statusToDate(order.statuses, status)}
        else if order.payment.pse
          .steps
            each status in ['paid','picking','ready','onway','completed']
              if _.find(order.statuses, {status})
                .step(class=statusToDate(order.statuses, status)?(order.status==status?' info-300':''):'')
                  .step-icon !{statusIcon(status)}
                  .step-content.hide-sm.hide-md.hide-lg
                    .step-title #{statusText(status)}
                    .step-description #{statusToDate(order.statuses, status)}
              else
                .step.disabled
                  .step-icon !{statusIcon(status)}
                  .step-content.hide-sm.hide-md.hide-lg
                    .step-title #{statusText(status)}
        else if !order.payment.pse
          .steps
            each status in ['picking','ready','onway','paid','completed']
              if _.find(order.statuses, {status})
                .step(class=statusToDate(order.statuses, status)?(order.status==status?' info-300':''):'')
                  .step-icon !{statusIcon(status)}
                  .step-content.hide-sm.hide-md.hide-lg
                    .step-title #{statusText(status)}
                    .step-description #{statusToDate(order.statuses, status)}
              else
                .step.disabled
                  .step-icon !{statusIcon(status)}
                  .step-content.hide-sm.hide-md.hide-lg
                    .step-title #{statusText(status)}

    .row
      .col-md-12
        .white.br-1.rd-0-2.p-1
          .row
            .col-md-6
              .map
                img.w-100(src=mapImg(order))
            .col-md-6
              table.table.table--striped
                tbody
                  tr
                    td.b Número de pedido:
                    td.b.number-order #{order.orderID}
                  tr
                    td.b.mt-1-xs Estado:
                    td.mt-1-xs.subtitle.status !{badge(order.status)}
                  tr
                    td.b.mt-1-xs Fecha de solicitud:
                    td.mt-1-xs.date-created #{statusToDate(order.statuses, 'created')}
                  tr
                    td.b.mt-1-xs Fecha de entrega:
                    td.mt-1-xs.date-delivery #{statusToDate(order.statuses, 'completed')}
                  tr
                    td.b.mt-1-xs Productos:
                    td.mt-1-xs.products #{order.products.length}
                  tr
                    td.b.mt-1-xs Total:
                    td.mt-1-xs.b.big.t-secondary.total #{formatMoney(order.order.total)}
                  tr
                    td.b.mt-1-xs Dirección de Entrega:
                    td.mt-1-xs.address #{order.address.city} #{order.address.address}
                  tr
                    td.b.mt-1-xs Nombre de contacto:
                    td.mt-1-xs.name #{order.userData.name}
                  tr
                    td.b.mt-1-xs Célular de contacto:
                    td.mt-1-xs.cellphone #{order.address.cellphone}
                  tr
                    td.b.mt-1-xs Forma de entrega:
                    td.mt-1-xs.name #{order.delivery.name}
                  tr
                    td.b.mt-1-xs Forma de Pago:
                    td.mt-1-xs.payment #{order.payment.name}
                  if _.get(order, 'payment.info.fields')
                    tr
                      td.b.mt-1-xs Detalles del Pago:
                      td.mt-1-xs.paymentFields
                        ul
                          each field,i in _.get(order, 'payment.info.fields')
                            if !field.hide
                              li
                                span.b #{field.label}:
                                | #{' '}
                                if field.type=="text"
                                  | #{_.get(order, `payment.fields.${i}.value`)}
                                if field.type=="select"
                                  | #{field.options[_.get(order, `payment.fields.${i}.value`)]}
                    if order.payment.slug !== 'wompi' && order.payment.pse
                      tr
                        td.b.mt-1-xs Comprobante:
                        td.mt-1-xs.paymentFile
                          if order.status === 'created'
                            | Esperando comprobante de pago
                          else if order.payment.slug === '2transfair'
                            a(href=_.get(payment, `urlPayment`) target="_blank") Ver
                              | #{' '}
                              i.fas.fa-external-link-alt
                          else if !order.payment.pse
                            a(href=_.get(order, `payment.file`) target="_blank") Ver
                              | #{' '}
                              i.fas.fa-external-link-alt
              .row
                .col-xl-8.vertical-align-center
                  +btnPayment(order)
                .col-xl-8.vertical-align-center
                  if order.status === 'created' || order.status === 'picking'
                    button.btn.btn--error.small.w-100.btn-cancel.mb-0-5(
                      id='id_'+order.orderID
                      data-order=order._id) Cancelar


    .row
      .col-md-12
        .mt-2
          .row
            .col-md-8
              h2 Pedido ##{order.orderID} de: #{order.store.name}
          table.hide-xs.small.table.table--lines
            thead
              tr
                th.tc(colspan='2') PRODUCTO
                th.tr PRECIO
                th.tr CANTIDAD
                th.tr SUBTOTAL
            tbody
              each product in order.products
                tr
                  td
                    +img(product.name, _.first(product.imagesSizes), ['48x48_jpg', '96x96_jpg'], 'h-48p')
                  td
                    .b #{product.name}
                  td.tr #{formatMoney(product.price)}
                  td.tr #{product.quantity}
                  td.tr.t-secondary.b #{formatMoney(product.price*product.quantity)}

            tfoot
              tr
                td.b(colspan='4') Subtotal
                td.tr.t-secondary #{formatMoney(order.order.subtotal)}
              tr
                td.b(colspan='4') Envío
                td.tr.t-secondary #{formatMoney(order.order.shipping)}
              tr
                td.b(colspan='4') Total
                td.tr.big.t-secondary.b #{formatMoney(order.order.total)}
          .show-xs
            each product in order.products
              table.small.table.table--striped
                tbody
                  tr
                    th.w-img-48
                      +img(product.name, _.first(product.imagesSizes), ['48x48_jpg', '96x96_jpg'], 'h-48p')
                    td.b.big #{product.name}
                  tr
                    th.b PRECIO
                    td.t-secondary #{formatMoney(product.price)}
                  tr
                    th.b CANTIDAD
                    td.big #{product.quantity}
                  tr
                    th.b SUBTOTAL
                    td.b.big.t-secondary #{formatMoney(product.price*product.quantity)}
            table.small.table.table--striped
              tbody
                tr
                  td.b Subtotal
                  td.tr.t-secondary #{formatMoney(order.order.subtotal)}
                tr
                  td.b Envío
                  td.tr.t-secondary #{formatMoney(order.order.shipping)}
                tr
                  td.b Total
                  td.tr.big.t-secondary.b #{formatMoney(order.order.total)}

  #cancelOrder.modal.start-hide(tabindex='-1' role='dialog')
    .modal-dialog(role='document')
      form#cancelOrderForm.col-xs-12.validate-rest(action=`${appCnf.url.api}orders/${order._id}/cancel` data-page=`/usuario/ordenes/cancelar-confirmacion` method="put" data-error="#form-results")
        .modal-content
          .modal-header
            .title.b Desea cancelar el pedido
            button.close.close-modal.btn-flat(type='button' data-dismiss='modal' aria-label='Cerrar')
              span(aria-hidden='true')
                i.fas.fa-times
          .modal-body
            .msg.error#form-results
            .row
              .col-xs-12
                .form-group
                  .form-control
                    select.input#reason(name="reason" required)
                      option(value='') -- Seleccione un motivo --
                      option(value='Ya no lo necesito') Ya no lo necesito
                      option(value='Me he arrepentido') Me he arrepentido
                      option(value='Voy hacer otro pedido') Voy hacer otro pedido
                      option(value='Voy a comprar en otro lugar') Voy a comprar en otro lugar
                      option(value='Otro motivo') Otro motivo
                    label(for='reason') Motivo
          .modal-footer.tr
            button.close-modal.btn.btn--secondary(type='button') Salir
            | #{' '}
            button.btn.btn--primary(type='submit') Confirmar cancelar

  include ../../fragments/modal-payment-file.pug